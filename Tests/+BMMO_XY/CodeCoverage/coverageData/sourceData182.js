var sourceData182 = {"FileContents":["function results_out = bmmo_sub_model_MIKA_EDGE(results_in, options)\r","% function results_out = bmmo_sub_model_MIKA_EDGE(results_in, options)\r","%\r","% The MIKA_EDGE sub-model (MI+KA_EDGE combo model). here KA is including\r","% polynomial and edge.\r","%\r","% Input:\r","%   results_in: structure containing at least the following fields:\r","%               interfield_residual: 1 * max_chuck structure array of chuck-averaged \r","%               overlay structures. This is the input to the MI sub-model.\r","%   options:    options structure\r","%\r","% Output:\r","%   results_out: structure containing intermediate models\r","%   This function modifies the following fields:\r","%           MI.res: 1*max_chuck array of ml structures; residual per\r","%               chuck id after fitting mirror model.\r","%           MI.Calib_MI: 1 * max chuck array of MI calibrations\r","%           interfield_residual: equal to MI.res\r","%           KA.res: 1*max_chuck array of ml structures; residual per\r","%               chuck id after fitting mirror model.\r","%           KA.Calib_KA: 1 * max chuck array of KA-grid (with edge model) calibrations.\r","%           BAO.before_MIKA_EDGE: BAO content removed before MIKA-modelling, for\r","%               ebug purpose only.\r","%           BAO.BAO_in_MIKA_EDGE: BAO content of MIKA_EDGE-combo model for crosstalk\r","%               estimation, for debug purpose only.\r","%\r","%   *** N.B. *** \r","%   MI(2) is the structure for chuck id 2, even if chuck id 2 is the\r","%   only chuck id used\r","\r","results_out = results_in;\r","model = 'MIKA_EDGE';\r","\r","%mi_input = results_out.interfield_residual;\r","% Reduce SDM fields to 7x7, edges are dense. Shall the edges be the same: 7x7?\r","for chuck_id = options.chuck_usage.chuck_id_used\r","    [mi_input(chuck_id), results_out.BAO.before_MIKA(chuck_id)] = bmmo_model_BAO(results_out.interfield_residual(chuck_id), options);\r","    out_ml_new(chuck_id) = bmmo_convert_layout2_7(mi_input(chuck_id),'x', options.fid_intrafield);\r","    out_ml_new(chuck_id) = bmmo_convert_layout2_7(out_ml_new(chuck_id),'y', options.fid_intrafield);\r","end\r","\r","mi_input = out_ml_new;\r","\r","\r","% Construct FPS for MI+KA, KA-fps contains only terms from 2nd order\r"," [fps, C] = bmmo_construct_FPS(mi_input, options, model);\r","\r","mli = mi_input;\r","\r","% Run the MI+KA combined model\r","[fit_coeffs, fitted_fps, res] = bmmo_combined_model(mli, fps, options, C);\r","for ichk=1:2\r","    fitted_fps.KA(ichk) = ovl_add(fitted_fps.KA_POLY(ichk), fitted_fps.KA_EDGE(ichk));\r","    fit_coeffs.KA{ichk} = [fit_coeffs.KA_POLY{ichk}; fit_coeffs.KA_EDGE{ichk}];\r","end\r","\r","% calculate MI part as sum of MIX and MIY\r","for chuck_id = options.chuck_usage.chuck_id_used\r","    fitted_fps.MI(chuck_id) = ovl_add(fitted_fps.MIX(chuck_id), fitted_fps.MIY(chuck_id));\r","end\r","\r","% MI+KA map consistency, convert and update\r","for chuck_id = options.chuck_usage.chuck_id_used\r","\r","    % Initial fit mirrors\r","    [res_MI(chuck_id), results_out.MI.Calib_MI(chuck_id)]= bmmo_generate_mirrors(mli(chuck_id), fit_coeffs.MIX{chuck_id},fit_coeffs.MIY{chuck_id}, options);\r","    \r","\t% find the linear terms in the resulting maps when interpolated to 7x7\r","    % layout and remove it from MI\r","    fp_tmp = bmmo_mirror_fingerprint(bmmo_get_layout(fitted_fps.MI(chuck_id), options.reduced_reticle_layout, options), results_out.MI.Calib_MI(chuck_id), options);\r","    fp_tmp = ovl_combine_linear(fp_tmp, 1, mi_input(chuck_id), 0);\r","    [~, pars] = bmmo_fit_model(fp_tmp, options, 'tx', 'rxwfr', 'ty', 'rwy');\r","    \r","    % Remove linear terms from mirror maps, and create \"final\" correction\r","    [results_out.MI.Calib_MI(chuck_id).x_mirr, results_out.MI.Calib_MI(chuck_id).y_mirr] = bmmo_model_map_parms(results_out.MI.Calib_MI(chuck_id).x_mirr, results_out.MI.Calib_MI(chuck_id).y_mirr, options, pars);\r","\r","    % Apply exposure side mirror maps to measure side  \r","    if options.invert_MI_wsm_sign\r","        results_out.MI.Calib_MI_wsm(chuck_id).x_mirr.dx = -1 * results_out.MI.Calib_MI(chuck_id).x_mirr.dx;\r","        results_out.MI.Calib_MI_wsm(chuck_id).y_mirr.dy = -1 * results_out.MI.Calib_MI(chuck_id).y_mirr.dy;\r","    else\r","        results_out.MI.Calib_MI_wsm(chuck_id) = results_out.MI.Calib_MI(chuck_id);\r","    end  \r","\r","    % Calculate mirror fingerprint (for debugging purposes)\r","    results_out.MI.fp(chuck_id) = bmmo_mirror_fingerprint(fitted_fps.MI(chuck_id), results_out.MI.Calib_MI(chuck_id), options);\r","    \r","    % Calculate mirror residual (for KPI, without average field)\r","    results_out.MI.res(chuck_id) = ovl_sub(mi_input(chuck_id), results_out.MI.fp(chuck_id));\r","    \r","    [~, results_out.KA.Calib_KA(chuck_id), results_out.KA.fp(chuck_id)] = bmmo_generate_grid(results_in.interfield_residual(chuck_id), fit_coeffs.KA{chuck_id}, options);\r","    \r","    % Apply exposure side KA grid to measure side\r","    if options.KA_measure_enabled\r","        results_out.KA.Calib_KA_meas(chuck_id) = bmmo_KA_grid_expose_to_meas(results_out.KA.Calib_KA(chuck_id), options);\r","    end\r","    % FF BAO Correction for MI and KA (for M-side)\r","    [results_out.BAO.ff_6par_MI(chuck_id), results_out.BAO.ff_6par_KA(chuck_id)] = bmmo_ff_bao_correction(results_out.MI.Calib_MI_wsm(chuck_id), results_out.KA.Calib_KA_meas(chuck_id), options);\r","    results_out.BAO.ff_6par(chuck_id) = bmmo_add_BAOs(results_out.BAO.ff_6par_MI(chuck_id), results_out.BAO.ff_6par_KA(chuck_id));\r","    \r","    % Re-calculate KA-residue from initial input, debug only info\r","    results_out.KA.res(chuck_id) = ovl_sub(mi_input(chuck_id), results_out.KA.fp(chuck_id));\r","\r","    % Model MI+KA\r","    % MI+KA fingerprint (for debugging purposes, without average field) \r","    results_out.MIKA.fp(chuck_id) = ovl_add(results_out.MI.fp(chuck_id), results_out.KA.fp(chuck_id));\r","    % Calculate MIKA-residue from initial input (without average field)\r","    results_out.MIKA.res(chuck_id) = ovl_sub(mi_input(chuck_id), results_out.MIKA.fp(chuck_id));\r","    \r","    % Find BAO in MIKA FP, to estimate KA-BAO crosstalk,\r","    [mlo, results_out.BAO.BAO_in_MIKA_EDGE(chuck_id)] = bmmo_model_BAO(ovl_combine_linear(results_out.MIKA.fp(chuck_id), -1), options);\r","    \r","    results_out.interfield_residual(chuck_id) = ovl_sub(results_out.interfield_residual(chuck_id), results_out.MIKA.fp(chuck_id));\r","end\r","\r",""],"CoverageData":{"CoveredLineNumbers":[],"UnhitLineNumbers":[32,33,37,38,39,40,43,47,49,52,53,54,55,59,60,64,67,71,72,73,76,79,80,81,82,83,87,90,92,95,96,99,100,103,107,109,112,114],"HitCount":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}}