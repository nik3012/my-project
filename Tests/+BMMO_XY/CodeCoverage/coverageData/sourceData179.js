var sourceData179 = {"FileContents":["function results_out = bmmo_sub_model_INTRAF(results_in, options)\r","% function results_out = bmmo_sub_model_INTRAF(results_in, options)\r","%\r","% The Intrafield sub-model\r","%\r","% Input:\r","%   results_in: structure containing various results from other models\r","%   models_in: structure containing intermediate models\r","%   options: options structure\r","%\r","% Output:\r","%   results_out: structure containing intermediate models\r","%       This function adds the following fields:\r","%           intrafield: 1*max chuck array, intrafield residual\r","%           *** N.B. *** \r","%           intrafield(2) is the structure for chuck id 2, even if chuck id 2 is the\r","%           only chuck id used\r","\r","results_out = results_in;\r","\r","for chuck_id = options.chuck_usage.chuck_id_used\r","    \r","    % Extract the defined intrafield fields\r","    results_out.INTRAF.residual(chuck_id) = ovl_get_fields(results_out.intrafield_input(chuck_id), options.fid_intrafield);\r","      \r","    % remove nans from intrafield\r","    results_out.INTRAF.residual(chuck_id) = bmmo_repair_intrafield_nans(results_out.INTRAF.residual(chuck_id),options);\r","    \r","    % remove the WH fingerprint from intrafield\r","    wh_fp = ovl_get_fields(ovl_combine_linear(options.WH.input_fp_per_chuck(chuck_id), results_out.WH.lambda), options.fid_intrafield);\r","    results_out.INTRAF.residual(chuck_id) = ovl_sub(results_out.INTRAF.residual(chuck_id), wh_fp);   \r","    \r","    % remove the SUSD fingerprint from intrafield\r","    SUSD_fp = ovl_get_fields(results_in.SUSD.model_fp(chuck_id), options.fid_intrafield);\r","    results_out.INTRAF.residual(chuck_id) = ovl_sub(results_out.INTRAF.residual(chuck_id), SUSD_fp);\r","    \r","    % remove the MI fingerprint from intrafield\r","    MI_fp = bmmo_mirror_fingerprint(results_out.INTRAF.residual(chuck_id), results_in.MI.Calib_MI(chuck_id), options);\r","    results_out.INTRAF.residual(chuck_id) = ovl_sub(results_out.INTRAF.residual(chuck_id), MI_fp);\r","    \r","    % Remove the KA fingerprint from intrafield\r","    ml_KA = feval(options.KA_actuation.fnhandle, results_in.KA.Calib_KA(chuck_id), results_out.INTRAF.residual(chuck_id), options);\r","    results_out.INTRAF.residual(chuck_id) = ovl_sub(results_out.INTRAF.residual(chuck_id), ml_KA);\r","    \r","    % Remove BAO from intrafield\r","    results_out.INTRAF.residual(chuck_id) = bmmo_apply_model(results_out.INTRAF.residual(chuck_id), results_in.BAO.correction(chuck_id), -1, options);\r","    %results_out.INTRAF.residual(chuck_id) = ovl_model(results_out.INTRAF.residual(chuck_id),'apply',results_in.BAO.correction(chuck_id),-1);\r","    \r","    % average fields to get intrafield\r","    results_out.INTRAF.Calib_intra(chuck_id) = ovl_average_fields( results_out.INTRAF.residual(chuck_id));\r","    \r","    % correct for RINT microshift and remove 6 intrafield pars\r","    results_out.INTRAF.Calib_intra(chuck_id) = bmmo_correct_intrafield_shift(results_out.INTRAF.Calib_intra(chuck_id), options);\r"," \r","    % options.intraf_fitmodel(_all) defines 18(20)par or 33(35)par.\r","    % results_out.INTRAF.par18 renamed to results_out.INTRAF.par\r","    %[unused, results_out.INTRAF.Calib_Kfactors(chuck_id)] = ovl_model(results_out.INTRAF.Calib_intra(chuck_id), '18par, d3, flw3y');\r","    [~, results_out.INTRAF.Calib_Kfactors(chuck_id)] = bmmo_fit_model(results_out.INTRAF.Calib_intra(chuck_id), options, options.intraf_fitmodel_all);\r","    %[results_out.INTRAF.residual(chuck_id), results_out.INTRAF.par18(chuck_id)] = ovl_model(results_out.INTRAF.Calib_intra(chuck_id), '18par');\r","    [results_out.INTRAF.residual(chuck_id), results_out.INTRAF.par(chuck_id)] = bmmo_fit_model(results_out.INTRAF.Calib_intra(chuck_id), options, options.intraf_fitmodel);\r","\r","end\r","\r",""],"CoverageData":{"CoveredLineNumbers":[19,21,24,27,30,31,34,35,38,39,42,43,46,50,53,58,60],"UnhitLineNumbers":[],"HitCount":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,119,0,119,0,0,232,0,0,232,0,0,232,232,0,0,232,232,0,0,232,232,0,0,232,232,0,0,232,0,0,0,232,0,0,232,0,0,0,0,232,0,232,0,0,0,0]}}