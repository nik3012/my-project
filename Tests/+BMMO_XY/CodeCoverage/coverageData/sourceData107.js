var sourceData107 = {"FileContents":["function [report, model_results] = bmmo_generate_lcp_report(mli, model_results, kpi_corr, options)\r","% function [report, model_results] = bmmo_generate_lcp_report(mli, model_results, kpi_corr, options)\r","%\r","% Process the results of BMMO-NXE and BL3 modelling, required for generating\r","% Waferdatamaps and Job report (KPIs) results as described in EDS D000810611\r","%\r","% Input:\r","%   mli: original input structure\r","%   model_results:  structure containing results of modelling\r","%   kpi_corr: structure containing the following SBC correction structures\r","%     delta_filtered\r","%     delta_unfiltered\r","%     total_filtered (equal to the SBC correction sent to TS)\r","%     total_unfiltered \r","%   options: BMMO/BL3 options structure\r","%\r","% Output:\r","%   report: KPI/PI report structure as defined in EDS D000810611\r","%   model_results: structure containing results of modelling (processed for\r","%   WDMs and other outputs)\r","\r","% Undo previous SBC corrections\r","[model_results.uncontrolled, model_results.sbc_prev] = bmmo_undo_sbc_correction(model_results.ml_outlier_removed, options);\r","\r","% get previously applied inline SDM\r","model_results.previous_actuated_inlineSDM = ovl_average_fields(ovl_get_fields(model_results.sbc_prev.INTRAF, options.fid_intrafield));\r","model_results.previous_actuated_inlineSDM = bmmo_shift_fields(model_results.previous_actuated_inlineSDM, -options.x_shift, -options.y_shift);\r","\r","% Get current SBC correction: filtered/unfiltered, total/delta\r","field_entries = fieldnames(kpi_corr);\r","tmp_options = options;\r","INVALID_VAL = 0;\r","mlo_wo_readout_nans = bmmo_replace_invalids(model_results.ml_outlier_removed, model_results.readout_nans, INVALID_VAL);\r","mlo = bmmo_replace_invalids(mlo_wo_readout_nans, model_results.outlier_stats.layer.wafer, INVALID_VAL);\r","\r","%  Estimate ff 6par fingerprint for all field entries\r","ff6p.applied          =  bmmo_ff_6par_fingerprint(mlo, options.previous_correction.MI.wsm, options.previous_correction.KA.grid_2dc, options);\r","ff6p.delta_unfiltered =  bmmo_ff_6par_fingerprint(mlo, kpi_corr.delta_unfiltered.MI.wsm, kpi_corr.delta_unfiltered.KA.grid_2dc, options);\r","ff6p.delta_filtered   =  ovl_combine_linear(ff6p.delta_unfiltered ,options.filter.coefficients.BAO);\r","ff6p.total_filtered   =  ovl_add(ff6p.applied, ff6p.delta_filtered);\r","ff6p.total_unfiltered =  ovl_add(ff6p.applied, ff6p.delta_unfiltered);\r","\r","for ifield = 1:length(field_entries)\r","    intraf = bmmo_INTRAF_SBC_fingerprint(mlo, kpi_corr.(field_entries{ifield}).ffp, options);\r","    tmp_options.previous_correction.IR2EUV = kpi_corr.(field_entries{ifield}).IR2EUV;\r","\r","    % save the sbc fps to model results structure\r","    model_results.(field_entries{ifield}) = bmmo_get_sbc_fingerprints(intraf, tmp_options, kpi_corr.(field_entries{ifield}), ff6p.(field_entries{ifield}));\r","    kpi_corr.(field_entries{ifield}).total_correction = model_results.(field_entries{ifield}).TotalSBCcorrection;\r","    kpi_corr.(field_entries{ifield}).ml_bao = model_results.(field_entries{ifield}).BAO;\r","    kpi_corr.(field_entries{ifield}).ml_intraf = bmmo_ffp_to_ml_simple(kpi_corr.(field_entries{ifield}).ffp);\r","    kpi_corr.(field_entries{ifield}).inter_corr = ovl_sub(kpi_corr.(field_entries{ifield}).total_correction, intraf);\r","    kpi_corr.(field_entries{ifield}).intraf_par = intraf; % was intraf_18par (or intraf_33par)\r","    \r","    % add Intrafield raw fp to the struct\r","    model_results.(field_entries{ifield}).INTRAF_raw = kpi_corr.(field_entries{ifield}).ml_intraf;\r","    % 18 (33) par NCE wdm, with field name INTRAF_18par_NCE (or 33par)\r","    model_results.(field_entries{ifield}).(options.intraf_nce_modelresult.name) = ovl_model(kpi_corr.(field_entries{ifield}).ml_intraf, 'perwafer', options.intraf_CETpar.name);\r","end\r","model_results.total_correction = kpi_corr.total_filtered.total_correction;\r","\r","% Calculate the model residual\r","model_results.res = ovl_add(model_results.ml_outlier_removed, kpi_corr.delta_filtered.total_correction);\r","\r","report.PI = bmmo_generate_PI(mli, model_results, options);\r","report.KPI = bmmo_generate_KPI(mli, model_results, kpi_corr, options);\r","\r","report.filter = bmmo_generate_filter_report(options);\r",""],"CoverageData":{"CoveredLineNumbers":[23,26,27,30,31,32,33,34,37,38,39,40,41,43,44,45,48,49,50,51,52,53,56,58,60,63,65,66,68],"UnhitLineNumbers":[],"HitCount":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,122,0,0,122,122,0,0,122,122,122,122,122,0,0,122,122,122,122,122,0,122,488,488,0,0,488,488,488,488,488,488,0,0,488,0,488,0,122,0,0,122,0,122,122,0,122,0]}}