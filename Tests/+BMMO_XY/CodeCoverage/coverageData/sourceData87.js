var sourceData87 = {"FileContents":["function [pars6_MI, pars6_KA] = bmmo_ff_bao_correction(MI_maps, KA_grid, options)\r","%function [pars6_MI, pars6_KA] = bmmo_ff_bao_correction(MI_maps, KA_grid, options)\r","%\r","% This function calculates FIWA 6-par offset needed for the mirror and KA \r","% grid maps to be applied on the measure side.\r","%\r","% Input:\r","% MI_maps: input mirror map on a chuck\r","% KA_grid:  input KA grid on a chuck\r","% options: BMMO/BL3 default options structure \r","%\r","% Output :\r","% pars_6_MI : FIWA 6-par offset with MI_maps\r","% pars_6_KA : FIWA 6-par offset with KA_grid\r","%\r","% For details of the model and definitions of in/out interfaces, refer to\r","% D000810611 EDS BMMO NXE drift control model\r","\r","if ~isfield(options.FIWA_mark_locations, 'x') || ~isfield(options.FIWA_mark_locations, 'y') ||...\r","        isempty(options.FIWA_mark_locations.x) || isempty(options.FIWA_mark_locations.y)\r","    error('options.FIWA_mark_locations structure incomplete or missing');\r","end\r","\r","% Construct wd struture with BF marks\r","ml_target.wd.xc = options.FIWA_mark_locations.x';\r","ml_target.wd.yc = options.FIWA_mark_locations.y';\r","ml_target.wd.xf = zeros(size(ml_target.wd.xc));\r","ml_target.wd.yf = ml_target.wd.xf;\r","ml_target.wd.xw = options.FIWA_mark_locations.x';\r","ml_target.wd.yw = options.FIWA_mark_locations.y';\r","ml_target.nwafer = 1;\r","ml_target.nlayer = 1;\r","ml_target.nmark =  1;\r","ml_target.nfield = length(ml_target.wd.xc);\r","\r","% Interpolate to FIWA marks using MI_maps\r","vx   = ~isnan( MI_maps.y_mirr.dy);\r","pos  = MI_maps.y_mirr.x;\r","meas = MI_maps.y_mirr.dy;\r","ml_out = ml_target;\r","ml_out.layer.wr.dy = interp1(pos(vx), meas(vx), ml_target.wd.xw);\r","\r","vx   = ~isnan( MI_maps.x_mirr.dx);\r","pos  = MI_maps.x_mirr.y;\r","meas = MI_maps.x_mirr.dx;\r","ml_out.layer.wr.dx = interp1(pos(vx), meas(vx), ml_target.wd.yw);\r","\r","%Estimate 6parwafer for MI maps offset in FIWA postions\r","ml_out = ovl_combine_linear(ml_out,-1);\r","[~, pars6_MI]  =   ovl_model(ml_out,'6parwafer');\r","pars6_MI = rmfield(pars6_MI,'d3');\r","\r","% Interpolate to FIWA marks using KA_grid\r","% Bilinear interpolation\r","KA_grid = bmmo_KA_fix_interpolant(KA_grid);\r","ml_out2 = ml_target;\r","ml_out2.layer.wr.dx = KA_grid.interpolant_x(ml_out2.wd.xw, ml_out2.wd.yw);\r","ml_out2.layer.wr.dy = KA_grid.interpolant_y(ml_out2.wd.xw, ml_out2.wd.yw);\r","\r","%Estimate 6parwafer for KA grid offset in FIWA postions\r","ml_out2 = ovl_combine_linear(ml_out2,-1);\r","[~, pars6_KA ]  =   ovl_model(ml_out2,'6parwafer');\r","pars6_KA = rmfield(pars6_KA,'d3');\r",""],"CoverageData":{"CoveredLineNumbers":[19,20,21,25,26,27,28,29,30,31,32,33,34,37,38,39,40,41,43,44,45,46,49,50,51,55,56,57,58,61,62,63],"UnhitLineNumbers":[],"HitCount":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1015,1015,1,0,0,0,1014,1014,1014,1014,1014,1014,1014,1014,1014,1014,0,0,1014,1014,1014,1014,1014,0,1014,1014,1014,1014,0,0,1014,1014,1014,0,0,0,1014,1014,1014,1014,0,0,1014,1014,1014,0]}}