var sourceData421 = {"FileContents":["\r","function add_kt_wo(kt_wo_in, kt_wo_offset, kt_wo_template)\r","% function add_kt_wo(kt_wo_in, kt_wo_offset, kt_wo_template)\r","%\r","% Add KT_wafers_out offset file kt_wo_offset to kt_wo_in, given\r","% kt_wo_template as the nominal mark positions of the offsets in\r","% kt_wo_offset, saving the result locally in the file KT_wo_delta\r","%\r","% Input  \r","%   kt_wo_in: KT_wafers_out file\r","%   kt_wo_offset: KT_wafers_out file containing offsets from nominal\r","%       positions only\r","%   kt_wo_template: KT_wafers_out file containing nominal positions of all\r","%       marks in kt_wo_offset\r","%\r","%  2016???? SBPR Creation\r","\r","\r","disp('loading KT wafers out files');\r","kt_in = dd2mat(0, kt_wo_in);\r","kt_template = dd2mat(0, kt_wo_template);\r","kt_offset = dd2mat(0, kt_wo_offset);\r","\r","markname = {'BMMO'    'BMMO_WID'    'EXPOSED!'};\r","marktype = {'FM_2'    'NVSM-X'    'XPA'};\r","\r","THRESH = 1e-6;\r","\r","temp_pos = [kt_template.AA_marks.position];\r","\r","offset_pos = [kt_offset.AA_marks.position];\r","\r","for in = 1:3\r","    for jn = 1:3\r","        disp(['matching [' markname{in} ',' marktype{jn} '] marks']);\r","        \r","        index_in = strcmp({kt_in(1).AA_marks.name}, markname{in}) & strcmp({kt_in(1).AA_marks.mark_type}, marktype{jn});\r","        index_temp = strcmp({kt_template.AA_marks.name}, markname{in}) & strcmp({kt_template.AA_marks.mark_type}, marktype{jn});\r","        \r","        temp_xy = [[temp_pos(index_temp).x]' [temp_pos(index_temp).y]'];\r","        offset_xy = [[offset_pos(index_temp).x]' [offset_pos(index_temp).y]'];\r","        \r","        linear_ids = find(index_in);\r","        \r","        if length(linear_ids) > 0    \r","            for iw = 1:length(kt_in)\r","\r","                kt_pos = [kt_in(iw).AA_marks.position];\r","                kt_xy = [[kt_pos(index_in).x]' [kt_pos(index_in).y]'];\r","\r","                % find the nearest match in temp_xy for each kt_xy\r","                [I, D] = knnsearch(temp_xy, kt_xy);\r","\r","                kt_xy = kt_xy + offset_xy(I, :);\r","\r","\r","                for id = 1:length(linear_ids)\r","                    if D(id) < THRESH\r","                        kt_in(iw).AA_marks(linear_ids(id)).position.x = kt_xy(id, 1);\r","                        kt_in(iw).AA_marks(linear_ids(id)).position.y = kt_xy(id, 2);\r","                    end\r","                end\r","            end\r","        end\r","    end\r","end\r","\r","mat2dd('KT_wo_delta', kt_in);"],"CoverageData":{"CoveredLineNumbers":[],"UnhitLineNumbers":[19,20,21,22,24,25,27,29,31,33,34,35,37,38,40,41,43,45,46,48,49,52,54,57,58,59,60,68],"HitCount":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}}