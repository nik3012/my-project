var sourceData362 = {"FileContents":["function ovl_KPI3_4 = bmmo_calc_KPI3_4(input_structs, sbcs)\r","% function ovl_KPI3_4 = bmmo_calc_KPI3_4(in, sbc)\r","%\r","% Calculate Overaly monitor Interfield and Intrafield KPIs (DeltaToReference\r","% and DeltaToPrevious) based on reference, previous and current BMMO\r","% job outputs\r","%\r","%Input:\r","%\r","% input_structs:  BMMO inputs (1x3 struct) of the three jobs read in by bmmo_read_lcp_zip\r","%      in the follwing sequence: reference, previous and current.\r","% sbcs: The output sbc recipes (1x3 struct) of the three jobs parsed in the\r","%      correct sequence(reference, previous and current.\r","%\r","% Output:\r","% ovl_KPI3_4: Overaly monitor KPIs, ovl.inter and ovl.intra\r","%\r","% See also: bmmo_calc_KPI3_4_from_zips\r","\r","for i = 1:length(input_structs)\r","    [mli(i), options(i)] = bmmo_process_input(input_structs(i));\r","    sbcrep(i) = input_structs(i).info.previous_correction;\r","    tf(i) = options(i).filter.coefficients;\r","    \r","    %Interfield NCE\r","    factor = 1;\r","    options(i).WH.use_input_fp_per_wafer = 1;\r","    fps_sbc(i)    = bmmo_apply_SBC_core(mli(i), sbcs(i), factor, options(i));\r","    fps_sbcrep(i) = bmmo_apply_SBC_core(mli(i), sbcrep(i), factor, options(i));\r","    \r","    delta_sbc_filtered(i) = sub_get_delta_sbc(fps_sbc(i), fps_sbcrep(i));\r","    delta_sbc_unfiltered(i) = sub_get_unfiltered(delta_sbc_filtered(i), tf(i));\r","    \r","    for ic = 1:2\r","        wafers_this_chuck = find(options(i).chuck_usage.chuck_id == ic);\r","        wafers_this_chuck = reshape(wafers_this_chuck, 1, []); % make horizontal for R13 compatibility\r","        inter_nce(i).ml(ic) = ovl_add(ovl_get_wafers(mli(i), wafers_this_chuck),...\r","            ovl_get_wafers(delta_sbc_unfiltered(i).TotalSBCcorrection, wafers_this_chuck));\r","        \r","        if strcmp(options(i).platform, 'LIS')% shift LIS BMMO outputs from RINT to XPA\r","            inter_nce(i).ml(ic) = bmmo_shift_fields(inter_nce(i).ml(ic), -options(i).x_shift, -options(i).y_shift);\r","        end\r","    end\r","    \r","    % Intrafield NCE\r","    sdm_res(i).ffp = input_structs(i).info.report_data.inline_sdm_residual;\r","    sbc_ffp = bmmo_ffp_to_ml(sbcs(i).ffp);\r","    sbcrep_ffp = bmmo_ffp_to_ml(sbcrep(i).ffp);\r","    res_ffp = bmmo_ffp_to_ml(sdm_res(i).ffp);\r","    for ic = 1:2\r","        intra_nce(i).ml(ic) = ovl_combine_linear(ovl_add(ovl_sub(ovl_get_wafers(sbc_ffp, ic),...\r","            ovl_get_wafers(sbcrep_ffp, ic)), ovl_get_wafers(res_ffp, ic)), 1/tf(i).INTRAF);\r","        intra_nce(i).ml(ic) = bmmo_fit_model(intra_nce(i).ml(ic), options(i), options(i).intraf_CETpar.name);\r","    end\r","end\r","\r","for ic = 1:2\r","    delta_to_ref_inter(ic) = ovl_sub(inter_nce(3).ml(ic), ovl_average(inter_nce(1).ml(ic)));\r","    ovl_KPI3_4.inter.to_ref(ic) = ovl_calc_overlay(delta_to_ref_inter(ic));\r","    \r","    delta_to_prev_inter(ic) = ovl_sub(inter_nce(3).ml(ic), ovl_average(inter_nce(2).ml(ic)));\r","    ovl_KPI3_4.inter.to_prev(ic) = ovl_calc_overlay(delta_to_prev_inter(ic));\r","    \r","    delta_to_ref_intra(ic) = ovl_sub(ovl_average(intra_nce(3).ml(ic)), ovl_average(intra_nce(1).ml(ic)));\r","    ovl_KPI3_4.intra.to_ref(ic) = ovl_calc_overlay(ovl_get_fields(delta_to_ref_intra(ic), 1));\r","    \r","    delta_to_prev_intra(ic) = ovl_sub(ovl_average(intra_nce(3).ml(ic)), ovl_average(intra_nce(2).ml(ic)));\r","    ovl_KPI3_4.intra.to_prev(ic) = ovl_calc_overlay(delta_to_prev_intra(ic));\r","end\r","% remove 3sd fields\r","ovl_KPI3_4.inter.to_ref = sub_remove_3sd(ovl_KPI3_4.inter.to_ref);\r","ovl_KPI3_4.inter.to_prev = sub_remove_3sd(ovl_KPI3_4.inter.to_prev);\r","ovl_KPI3_4.intra.to_ref = sub_remove_3sd(ovl_KPI3_4.intra.to_ref);\r","ovl_KPI3_4.intra.to_prev = sub_remove_3sd(ovl_KPI3_4.intra.to_prev);\r","\r","end\r","\r","\r","function delta_fps = sub_get_delta_sbc(fps_sbc, fps_sbcrep)\r","\r","fn = fieldnames(fps_sbc);\r","for i = 1:length(fn)\r","    delta_fps.(fn{i}) = ovl_sub(fps_sbc.(fn{i}), fps_sbcrep.(fn{i}));\r","end\r","end\r","\r","\r","function delta_sbc_unfiltered = sub_get_unfiltered(fps_sbc, filter)\r","\r","delta_sbc_unfiltered.TotalSBCcorrection = (ovl_combine_linear(fps_sbc.TotalSBCcorrection, 0));\r","fn = fieldnames(filter);\r","for i = 1:length(fn)\r","    delta_sbc_unfiltered.(fn{i}) = ovl_combine_linear((fps_sbc.(fn{i})), 1/filter.(fn{i}));\r","    delta_sbc_unfiltered.TotalSBCcorrection = ovl_add(delta_sbc_unfiltered.TotalSBCcorrection, delta_sbc_unfiltered.(fn{i}));\r","end\r","end\r","\r","\r","function ovl_field = sub_remove_3sd(ovl_field)\r","\r","if isfield(ovl_field, 'oy3sd')\r","    ovl_field = rmfield(ovl_field, 'oy3sd');\r","end\r","if isfield(ovl_field, 'ox3sd')\r","    ovl_field = rmfield(ovl_field, 'ox3sd');\r","end\r","end"],"CoverageData":{"CoveredLineNumbers":[20,21,22,23,26,27,28,29,31,32,34,35,36,37,38,40,41,46,47,48,49,50,51,52,53,57,58,59,61,62,64,65,67,68,71,72,73,74,81,82,83,90,91,92,93,94,101,102,104,105],"UnhitLineNumbers":[],"HitCount":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,12,12,12,0,0,12,12,12,12,0,12,12,0,12,24,24,24,24,0,24,22,0,0,0,0,12,12,12,12,12,24,24,24,0,0,0,4,8,8,0,8,8,0,8,8,0,8,8,0,0,4,4,4,4,0,0,0,0,0,0,12,12,84,0,0,0,0,0,0,12,12,12,72,72,0,0,0,0,0,0,16,16,0,16,16,0,0]}}