var sourceData183 = {"FileContents":["function results_out = bmmo_sub_model_SUSD_1L(results_in, options)\r","% function results_out = bmmo_sub_model_SUSD_1L(results_in, options)\r","%\r","% The SUSD sub-model, used for one layer input\r","%\r","% Input:\r","%   results_in: structure containing various results from other models\r","%   options: options structure\r","%\r","% Output:\r","%   results_out: structure containing intermediate models and results\r","%       This function adds the field SUSD, with the following subfields:\r","%           model: SUSD model\r","%           Calib_SUSD: SUSD calibrations\r","%           fp: (only if not already in WH combined model) SUSD fingerprint\r","%\r","%       If it does not exist, it also adds the field WH with the subfields\r","%       ml7x7 and FPS. (see bmmo_sub_model_WH for definitions).\r","\r","results_out = results_in;\r","model = 'SUSD_1L';\r","\r","if ~isfield(results_out.WH, 'ml_7x7') || ~isfield(results_out.WH, 'FPS')\r","    [results_out.WH.ml_7x7, results_out.WH.FPS] = bmmo_setup_combined_model(results_in.WH.input, options, model);\r","end\r","\r","susd_options = options;\r","\r","% Remove edge fields\r","for ic = options.chuck_usage.chuck_id_used\r","    [~, edge_fieldnos] = ovl_get_innerfields(results_out.WH.ml_7x7(ic), 'radius', options.edge_clearance, 'marks', 'invert');\r","    results_out.WH.ml_7x7(ic) = ovl_combine_linear(results_out.WH.ml_7x7(ic), 1, ovl_combine_linear(ovl_get_fields(results_out.WH.ml_7x7(ic), edge_fieldnos), NaN));\r","end\r","\r","% switch in WH fingerprint\r","susd_FPS = results_out.WH.FPS;\r","\r","% perform the fit and add the correction to the monitoring \r","[fit_coeffs, fitted_fps] = bmmo_combined_model(results_out.WH.ml_7x7, susd_FPS, susd_options);\r","    \r","    \r","% gather the SUSD output   \r","for chuck_id = options.chuck_usage.chuck_id_used\r","    results_out.SUSD.Calib_SUSD(chuck_id) = fit_coeffs.SUSD{chuck_id}*1/options.scaling_factor;\r","    results_out.SUSD.fitted_fp(chuck_id) = fitted_fps.SUSD(chuck_id);\r","end\r","results_out.SUSD.Monitor_SUSD = results_out.SUSD.Calib_SUSD;\r","\r","\r","% Calculate SUSD residual \r","for ic = options.chuck_usage.chuck_id_used\r","        results_out.SUSD.model_fp(ic) = bmmo_SUSD_fingerprint(ovl_combine_linear(options.WH.input_fp_per_chuck(ic), 0), options.Scan_direction, results_out.SUSD.Calib_SUSD(ic));\r","        results_out.SUSD.res(ic) = ovl_sub(results_out.interfield_residual(ic), results_out.SUSD.model_fp(ic));\r","end\r","results_out.interfield_residual = results_out.SUSD.res;\r",""],"CoverageData":{"CoveredLineNumbers":[20,21,23,24,27,30,31,32,36,39,43,44,45,47,51,52,53,55],"UnhitLineNumbers":[],"HitCount":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,17,17,0,17,17,0,0,17,0,0,17,34,34,0,0,0,17,0,0,17,0,0,0,17,34,34,0,17,0,0,0,17,34,34,0,17,0]}}