function wdm = bmmo_generate_WDM(model_results, options)
% function wdm = bmmo_generate_WDM(model_results, options)
%
% Process the results of BMMO-NXE and BL3 modelling for the creation of 
% waferdatamaps
%
% Input:
%   model_results: structure containing results of modelling and
%                  delta_filtered
%                  delta_unfiltered
%                  total_filtered
%                  total_unfiltered
%   options: BMMO/BL3 options structure
%
% Output:
%   wdm: Waferdatamaps as defined in  EDS D000810611

wdm.controlled_meas_per_wafer = model_results.ml_outlier_removed;
wdm.controlled_meas = bmmo_average_chuck(model_results.ml_outlier_removed, options);
wdm.uncontrolled_meas_per_wafer = model_results.uncontrolled;
wdm.uncontrolled_meas = bmmo_average_chuck(model_results.uncontrolled, options);
wdm.model_residual = bmmo_average_chuck(model_results.res, options);
wdm.previous_actuated_inlineSDM = bmmo_average_chuck(model_results.previous_actuated_inlineSDM, options);

if isfield(model_results.delta_unfiltered, options.intraf_nce_modelresult.name)
    model_results.delta_unfiltered = rmfield(model_results.delta_unfiltered, options.intraf_nce_modelresult.name);
end

correctiondata = {'total_filtered', 'total_unfiltered', 'delta_unfiltered'};
corrset = {'SUSD', 'KA', 'MI', 'BAO', 'TotalSBCcorrection'};

for corrdat_i = 1:length(correctiondata)
    wdm.(correctiondata{corrdat_i}) = model_results.(correctiondata{corrdat_i});
    
    % remove 18/33 par INTRAF as it will be generated by analytics
    wdm.(correctiondata{corrdat_i}) = rmfield(wdm.(correctiondata{corrdat_i}), 'INTRAF');
    
    % wafer average for WH correction, if 2L get 89 fields
    % using bmmo_average_chuck before averaging all wafers since
    % ovl_average gives incorrect values for odd wafers
    wdm_tmp1 = (wdm.(correctiondata{corrdat_i}).WH);
    wdm_tmp1 = bmmo_average_chuck(wdm_tmp1, options);
    wdm_tmp = ovl_average(wdm_tmp1(1),wdm_tmp1(2),'overall');

    wdm.(correctiondata{corrdat_i}).WH = sub_select_89_fields(wdm_tmp, options);
    
    % chuck average the rest of the non-chuck avg corrections
    for corrset_i = 1:length(corrset)
        wdm_tmp = wdm.(correctiondata{corrdat_i}).(corrset{corrset_i});
        wdm_tmp = bmmo_average_chuck(wdm_tmp, options);
        
        % if these wdms are in 2L get 89 fields
        for ichk = 1:length(wdm_tmp)
            wdm.(correctiondata{corrdat_i}).(corrset{corrset_i})(ichk) =  sub_select_89_fields(wdm_tmp(ichk), options);
        end
    end
end

% if the rest of the wdms are in 2L get 89 fields
other = {'uncontrolled_meas', 'controlled_meas', 'model_residual', 'controlled_meas_per_wafer', 'uncontrolled_meas_per_wafer'};
for irest = 1:length(other)
    for ichk = 1:length(wdm.(other{irest}))
        wdm.(other{irest})(ichk) = sub_select_89_fields(wdm.(other{irest})(ichk), options);
    end
end


function wdm_1L_f = sub_select_89_fields(wdm_in, options)
  if wdm_in.nfield > 89
     wdm_1L_f = ovl_get_fields(wdm_in, [options.layer_fields{1}, options.edge_fields]);
  else
     wdm_1L_f = wdm_in;
  end