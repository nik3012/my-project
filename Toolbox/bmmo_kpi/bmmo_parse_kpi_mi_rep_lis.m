function kpi_mi = bmmo_parse_kpi_mi_rep_lis(kpi_rep_mi1, kpi_rep_mi2, mode)
%
% function kpi_mi = bmmo_parse_kpi_mi_rep_lis(kpi_rep_mi1, kpi_rep_mi2)
%
%Given the Mirror Correction Magnitude KPIs and statistics from the LIS job report, parse the
%contents into a BMMO-NXE kpi structure
% Input:
%   kpi_rep_mi1: Mirror Correction Magnitude KPIs  Chuck 1 from the job report
%   kpi_rep_mi2: Mirror Correction Magnitude KPIs  Chuck 2 from the job report
%   mode       : 'kpi' for parsing  - wafer:99.7, M3s
%              : 'kpi2' for parsing - wafer: Max, full: 99.7, M3s, Max
%              : 'all' for parsing  - wafer and full all metrics
% Output:
%   kpi_mi: Mirror KPI (wafer: Max, full: 99.7, M3s, Max) Correction Magnitude structure as generated by
%   BMMO model
%
% Changelog
% 20200812  ANBZ Creation

rep_map = {'XTY', ...
    'YTX', ...
    'Wafer', ...
    'Full', ...
    'Max', ...
    'Max99.7', ...
    'M3s'};

kpi_map = {'xty', ...
    'ytx', ...
    'wafer', ...
    'full', ...
    'max', ...
    '997', ...
    'm3s'};

kpi_chuck = { 'chk1', 'chk2'};

mimaps = [1 2];


% select metrics based on mode    
if strcmp(mode, 'kpi')
wfr1   = 3;
stats1 = [6 7];
elseif strcmp(mode, 'kpi2')
    wfr1   = 3;
    wfr2   = 4;
    stats1 = 5;
    stats2 = [5 6 7];
elseif strcmp(mode, 'all')
    wfr1   = 3;
    wfr2   = 4;
    stats1 = [5 6 7];
    stats2 = [5 6 7];
end


for imap = mimaps
    for iwfr = wfr1
        for istat = stats1
            for ichk = 1
                fname = ['ovl_exp_' kpi_map{imap} '_' kpi_map{istat} '_' kpi_map{iwfr} '_' kpi_chuck{ichk}];
                val = kpi_rep_mi1.(rep_map{imap}).(rep_map{iwfr}).(rep_map{istat});
                kpi_mi.(fname) = str2double(val) * 1e-9;
            end
            
            for ichk = 2
                fname = ['ovl_exp_' kpi_map{imap} '_' kpi_map{istat} '_' kpi_map{iwfr} '_' kpi_chuck{ichk}];
                val = kpi_rep_mi2.(rep_map{imap}).(rep_map{iwfr}).(rep_map{istat});
                kpi_mi.(fname) = str2double(val) * 1e-9;
            end
        end
    end
end


if strcmp(mode, 'kpi2') || strcmp(mode,'all')
for imap = mimaps
    for iwfr = wfr2
        for istat = stats2
            for ichk = 1
                fname = ['ovl_exp_' kpi_map{imap} '_' kpi_map{istat} '_' kpi_map{iwfr} '_' kpi_chuck{ichk}];
                val = kpi_rep_mi1.(rep_map{imap}).(rep_map{iwfr}).(rep_map{istat});
                kpi_mi.(fname) = str2double(val) * 1e-9;
            end
            
            for ichk = 2
                fname = ['ovl_exp_' kpi_map{imap} '_' kpi_map{istat} '_' kpi_map{iwfr} '_' kpi_chuck{ichk}];
                val = kpi_rep_mi2.(rep_map{imap}).(rep_map{iwfr}).(rep_map{istat});
                kpi_mi.(fname) = str2double(val) * 1e-9;
            end
        end
    end
end
end