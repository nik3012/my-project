function kpi_res = bmmo_parse_kpi_res(kpi_rep_res)
%
% function kpi_res = bmmo_parse_kpi_res(kpi_rep_res)
%
%Given the Correction quality KPIs from the OTAS job report, parse the
%contents into a BMMO-NXE kpi structure
% Input:
%   kpi_rep_res  :  correction quality KPIs  
%
% Output:
%   kpi_res:  KPI correction quality structure as generated by
%   BMMO model
%
% Changelog
% 20171030 SBPR Creation

% field names in job report and MATLAB

kpi_res.overlay = bmmo_parse_kpi_overlay(kpi_rep_res.ResidualOverlay);

kpi_res.interfield = sub_parse_kpi_res_interfield(kpi_rep_res.ResidualInterfield);

kpi_res.intrafield = sub_parse_kpi_res_intrafield(kpi_rep_res.ResidualIntrafield);


function kpi_inter = sub_parse_kpi_res_interfield(kpi_res_inter)

chucks = {'chk1', 'chk2'};
chucks_rep = {'Chuck1', 'Chuck2'};

for ic = 1:2
    kpi_inter.(['ovl_grid_' chucks{ic} '_res_997']) = str2double(kpi_res_inter.ExposureGrid.('Max99.7').(chucks_rep{ic})) * 1e-9;
    kpi_inter.(['ovl_exp_ytx_max_wafer_' chucks{ic}]) =  str2double(kpi_res_inter.MirrorMaps.YTX.Wafer.Max.(chucks_rep{ic})) * 1e-9;
    kpi_inter.(['ovl_exp_xty_max_wafer_' chucks{ic}]) =  str2double(kpi_res_inter.MirrorMaps.XTY.Wafer.Max.(chucks_rep{ic})) * 1e-9;   
end


function kpi_intra = sub_parse_kpi_res_intrafield(kpi_res_intra)

chucks = {'chk1', 'chk2'};
chucks_rep = {'Chuck1', 'Chuck2'};
dims = {'x', 'y'};
dims_rep = {'X', 'Y'};

for ic = 1:2
    for id = 1:2
        kpi_intra.(['ovl_exp_field_HO_res_' dims{id} '_before_' chucks{ic}]) = str2double(kpi_res_intra.ExposureField.Ho.Before.(dims_rep{id}).(chucks_rep{ic})) * 1e-9;
        kpi_intra.(['ovl_exp_field_HO_res_' dims{id} '_res_' chucks{ic}]) =  str2double(kpi_res_intra.ExposureField.Ho.After.(dims_rep{id}).(chucks_rep{ic})) * 1e-9;
        kpi_intra.(['ovl_exp_field_HO_res_' dims{id} '_delta_' chucks{ic}]) =  str2double(kpi_res_intra.ExposureField.Ho.Delta.(dims_rep{id}).(chucks_rep{ic})) * 1e-9;   
    end
end



