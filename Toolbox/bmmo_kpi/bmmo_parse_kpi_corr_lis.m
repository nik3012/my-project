function kpi_corr = bmmo_parse_kpi_corr_lis(kpi_rep, stats_rep)
%
% function kpi_corr = bmmo_parse_kpi_corr_lis(kpi_rep,stats_rep)
%
%Given the Correction Magnitude KPIs and statistics from the LIS job report, parse the
%contents into a BMMO-NXE kpi structure
% Input:
%   kpi_rep:   Correction Magnitude KPIs from job report
%   stats_rep: Correction Magnitude stats from job report
%
% Output:
%   kpi_corr: KPI Correction Magnitude structure as generated by bmmo_nxe_drift_control_model
%
% Changelog
% 20200812  ANBZ Creation
% 20201119  OGIE Update for intra_33_par

kpi_fields     = {'delta_filtered', 'total_filtered'};
kpi_fields2    = {'delta_unfiltered', 'total_unfiltered'};
rep_fields     = {'DeltaFilteredCalibration' 'TotalFilteredCalibration'};
rep_fields2    = {'DeltaUnfilteredCalibration' 'TotalUnfilteredCalibration'};
rep_kf_fields  = {'DeltaFilteredMonitoring', 'TotalFilteredMonitoring'};
rep_kf_fields2 = {'DeltaUnfilteredMonitoring', 'TotalUnfilteredMonitoring'};

% Filtered, KPI 99.7 and m3sigma
for ii = 1:length(rep_fields)
    %Mirror
    kpi_corr.(kpi_fields{ii}).mirror.exp =  bmmo_parse_kpi_mi_rep_lis(kpi_rep(1).(rep_fields{ii}).MirrorExposure,...
        kpi_rep(2).(rep_fields{ii}).MirrorExposure,'kpi');
    kpi_corr.(kpi_fields{ii}).mirror.meas =   bmmo_parse_kpi_mi_rep_lis(stats_rep(1).(rep_fields{ii}).MirrorMeasure,...
        stats_rep(2).(rep_fields{ii}).MirrorMeasure, 'all');
    
    %Wafer heating
    kpi_corr.(kpi_fields{ii}).waferheating.ovl_exp_grid_whc = str2double(kpi_rep(3).(rep_fields{ii}).WaferHeating.WaferHeatingIrEuvRatio);
    
    % KA grid (when enabled)
    if isfield(kpi_rep(1).(rep_fields{ii}),'KaExposureGrid')
        kpi_corr.(kpi_fields{ii}).grid.exp = bmmo_parse_kpi_overlay_lis(kpi_rep(1).(rep_fields{ii}).KaExposureGrid,...
            kpi_rep(2).(rep_fields{ii}).KaExposureGrid, 'kpi');
    end
    if isfield(stats_rep(1).(rep_fields{ii}),'KaMeasureGrid')
        kpi_corr.(kpi_fields{ii}).grid.meas = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_fields{ii}).KaMeasureGrid,...
            stats_rep(2).(rep_fields{ii}).KaMeasureGrid, 'all');
    end
    
    % BAO metrics
    kpi_corr.(kpi_fields{ii}).bao = bmmo_parse_kpi_overlay_lis(kpi_rep(1).(rep_fields{ii}).BaoMetrics,...
        kpi_rep(2).(rep_fields{ii}).BaoMetrics, 'kpi');
    
    % Total correction overlay
    kpi_corr.(kpi_fields{ii}).total = bmmo_parse_kpi_overlay_lis(kpi_rep(1).(rep_fields{ii}).CorrectionOverlayMetrics,...
        kpi_rep(2).(rep_fields{ii}).CorrectionOverlayMetrics,'kpi');
    
    % Intrafield metrics
    if isfield(kpi_rep(1).(rep_fields{ii}),'Intrafield18ParMetrics')
        % Intrafield 18 par metrics
        kpi_corr.(kpi_fields{ii}).intra_18_par = bmmo_parse_kpi_overlay_lis(kpi_rep(1).(rep_fields{ii}).Intrafield18ParMetrics,...
            kpi_rep(2).(rep_fields{ii}).Intrafield18ParMetrics, 'kpi');
    else
        % Intrafield 33 par metrics
        kpi_corr.(kpi_fields{ii}).intra_33_par = bmmo_parse_kpi_overlay_lis(kpi_rep(1).(rep_fields{ii}).Intrafield33ParMetrics,...
            kpi_rep(2).(rep_fields{ii}).Intrafield33ParMetrics, 'kpi');
    end
    
    % SUSD (when enabled)
    if isfield(kpi_rep(1).(rep_fields{ii}),'Susd')
        kpi_corr.(kpi_fields{ii}).susd.ovl_exp_grid_chk1_ty_susd  =  str2double(kpi_rep(1).(rep_fields{ii}).Susd.Translation.Y) * 1e-9;
        kpi_corr.(kpi_fields{ii}).susd.ovl_exp_grid_chk2_ty_susd  =  str2double(kpi_rep(2).(rep_fields{ii}).Susd.Translation.Y) * 1e-9;
    end
end


% Filtered, KPI max and 3sigma
for ii = 1:length(rep_fields)
    % BAO metrics
    kpin_corr.(kpi_fields{ii}).bao = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_fields{ii}).BaoMetrics,...
        stats_rep(2).(rep_fields{ii}).BaoMetrics, 'kpi2');
    
    % BAO paramters
    kpin_corr.(kpi_fields{ii}).bao = bmmo_parse_kpi_bao_rep_lis(kpin_corr.(kpi_fields{ii}).bao,...
        stats_rep(1).(rep_fields{ii}).Bao, stats_rep(2).(rep_fields{ii}).Bao);
    
    % KA grid (when enabled)
    if  isfield(stats_rep(1).(rep_fields{ii}),'KaExposureGrid')
        kpin_corr.(kpi_fields{ii}).grid.exp   = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_fields{ii}).KaExposureGrid,...
            stats_rep(2).(rep_fields{ii}).KaExposureGrid, 'kpi2');
    end
    
    
    if  isfield(stats_rep(1).(rep_fields{ii}),'Clamp')
        kpin_corr.(kpi_fields{ii}).clamp   =  bmmo_parse_clamp_pi_lis(stats_rep(1).(rep_fields{ii}).Clamp,...
            stats_rep(2).(rep_fields{ii}).Clamp, 'modelled');
        kpi_corr.(kpi_fields{ii}).clamp  = kpin_corr.(kpi_fields{ii}).clamp; 
    end
    % Mirror
    kpin_corr.(kpi_fields{ii}).mirror.exp = bmmo_parse_kpi_mi_rep_lis(stats_rep(1).(rep_fields{ii}).MirrorExposure,...
        stats_rep(2).(rep_fields{ii}).MirrorExposure,'kpi2');
    
    % Intrafield raw metrics
    kpin_corr.(kpi_fields{ii}).intra_raw = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_fields{ii}).IntrafieldRawFingerprintMetrics,...
        stats_rep(2).(rep_fields{ii}).IntrafieldRawFingerprintMetrics, 'all');
    
    % Total correction overlay
    kpin_corr.(kpi_fields{ii}).total = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_fields{ii}).CorrectionOverlayMetrics,...
        stats_rep(2).(rep_fields{ii}).CorrectionOverlayMetrics,'kpi2');
    
    if isfield(stats_rep(1).(rep_fields{ii}), 'Intrafield18ParMetrics')
        % Intrafield 18 par metrics
        kpin_corr.(kpi_fields{ii}).intra_18_par = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_fields{ii}).Intrafield18ParMetrics,...
        stats_rep(2).(rep_fields{ii}).Intrafield18ParMetrics, 'kpi2');
    else
        % Intrafield 33 par metrics
        kpin_corr.(kpi_fields{ii}).intra_33_par = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_fields{ii}).Intrafield33ParMetrics,...
        stats_rep(2).(rep_fields{ii}).Intrafield33ParMetrics, 'kpi2');
    end
    
    % K-factor metrics
    kpi_corr.(kpi_fields{ii}).k_factors = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_kf_fields{ii}).KFactorsMetrics,...
        stats_rep(2).(rep_kf_fields{ii}).KFactorsMetrics, 'all');
    
    % K-factors (k7-k20 for 20par, or selection from k7-k51 for 35par)
    kpi_corr.(kpi_fields{ii}).k_factors = bmmo_parse_kpi_ho_rep_lis(kpi_corr.(kpi_fields{ii}).k_factors,...
        stats_rep(1).(rep_kf_fields{ii}).KFactors, stats_rep(2).(rep_kf_fields{ii}).KFactors);
    
    % copy filtered Intrafield raw metrics to kpi_corr struct 
    kpi_corr.(kpi_fields{ii}).intra_raw = kpin_corr.(kpi_fields{ii}).intra_raw;  
  
    % copy remaining metrics (Max and 3s) of filtered to kpi_corr from kpin corr
    f2 = fieldnames(kpin_corr.(kpi_fields{ii}));
    for iii = 1:length(f2)
        kpi_corr.(kpi_fields{ii}).(f2{iii}) = bmmo_add_missing_fields(kpi_corr.(kpi_fields{ii}).(f2{iii}), kpin_corr.(kpi_fields{ii}).(f2{iii}), 2);
    end   
end


% statistics Unfiltered (99.7, m3sigma, max, 3sigma)
for ii = 1:length(rep_fields2)
    
    % Wafer heating
    kpi1_corr.(kpi_fields2{ii}).waferheating.ovl_exp_grid_whc =  str2double(stats_rep(3).(rep_fields2{ii}).WaferHeating.WaferHeatingIrEuvRatio);
    
    % Intrafield raw metrics
    kpi1_corr.(kpi_fields2{ii}).intra_raw = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_fields2{ii}).IntrafieldRawFingerprintMetrics,...
        stats_rep(2).(rep_fields2{ii}).IntrafieldRawFingerprintMetrics, 'all');
    
    % SUSD (when enabled)
    if isfield(stats_rep(1).(rep_fields2{ii}),'Susd')
        kpi1_corr.(kpi_fields2{ii}).susd.ovl_exp_grid_chk1_ty_susd  =  str2double(stats_rep(1).(rep_fields2{ii}).Susd.Translation.Y) * 1e-9;
        kpi1_corr.(kpi_fields2{ii}).susd.ovl_exp_grid_chk2_ty_susd  =  str2double(stats_rep(2).(rep_fields2{ii}).Susd.Translation.Y) * 1e-9;
    end
    
    % Mirror 
    kpi1_corr.(kpi_fields2{ii}).mirror.exp =  bmmo_parse_kpi_mi_rep_lis(stats_rep(1).(rep_fields2{ii}).MirrorExposure,...
        stats_rep(2).(rep_fields2{ii}).MirrorExposure, 'all');
        kpi1_corr.(kpi_fields2{ii}).mirror.meas =   bmmo_parse_kpi_mi_rep_lis(stats_rep(1).(rep_fields2{ii}).MirrorMeasure,...
        stats_rep(2).(rep_fields2{ii}).MirrorMeasure, 'all');
    
    % KA (when enabled)
    if isfield(stats_rep(1).(rep_fields2{ii}),'KaExposureGrid')
        kpi1_corr.(kpi_fields2{ii}).grid.exp = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_fields2{ii}).KaExposureGrid,...
            stats_rep(2).(rep_fields2{ii}).KaExposureGrid, 'all');
    end
    if isfield(stats_rep(1).(rep_fields2{ii}),'KaMeasureGrid')
        kpi1_corr.(kpi_fields2{ii}).grid.meas = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_fields2{ii}).KaMeasureGrid,...
            stats_rep(2).(rep_fields2{ii}).KaMeasureGrid, 'all');
    end
    
    % BAO metrics
    kpi1_corr.(kpi_fields2{ii}).bao = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_fields2{ii}).BaoMetrics,...
        stats_rep(2).(rep_fields2{ii}).BaoMetrics, 'all');
    
    % BAO paramters
    kpi1_corr.(kpi_fields2{ii}).bao = bmmo_parse_kpi_bao_rep_lis(kpi1_corr.(kpi_fields2{ii}).bao,...
        stats_rep(1).(rep_fields2{ii}).Bao, stats_rep(2).(rep_fields2{ii}).Bao);
    
    % Total correction overlay
    kpi1_corr.(kpi_fields2{ii}).total = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_fields2{ii}).CorrectionOverlayMetrics,...
        stats_rep(2).(rep_fields2{ii}).CorrectionOverlayMetrics, 'all');
    
    if isfield(stats_rep(1).(rep_fields2{ii}), 'Intrafield18ParMetrics')
        % Intrafield 18 par metrics
        kpi1_corr.(kpi_fields2{ii}).intra_18_par  = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_fields2{ii}).Intrafield18ParMetrics,...
            stats_rep(2).(rep_fields2{ii}).Intrafield18ParMetrics, 'all');
    else
        % Intrafield 33 par metrics
        kpi1_corr.(kpi_fields2{ii}).intra_33_par  = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_fields2{ii}).Intrafield33ParMetrics,...
            stats_rep(2).(rep_fields2{ii}).Intrafield33ParMetrics, 'all');
        
    end
    
    % K-factors metrics
    kpi1_corr.(kpi_fields2{ii}).k_factors = bmmo_parse_kpi_overlay_lis(stats_rep(1).(rep_kf_fields2{ii}).KFactorsMetrics,...
        stats_rep(2).(rep_kf_fields2{ii}).KFactorsMetrics, 'all');
    
    % K-factors (k7-k20 for 20par, or selection from k7-k51 for 35par)
    kpi1_corr.(kpi_fields2{ii}).k_factors = bmmo_parse_kpi_ho_rep_lis(kpi1_corr.(kpi_fields2{ii}).k_factors,...
        stats_rep(1).(rep_kf_fields2{ii}).KFactors,stats_rep(2).(rep_kf_fields2{ii}).KFactors);
end

% copy unfiltered metrics from kpi1_corr to kpi_corr
kpi_corr = bmmo_add_missing_fields(kpi_corr, kpi1_corr, 2);


% Delta Monitoring General  KPIs
% SUSD
kpi_corr.monitor.susd.ovl_exp_grid_chk1_ty_susd = str2double(stats_rep(1).DeltaMonitoringGeneral.SuSd.Translation.Y) * 1e-9;
kpi_corr.monitor.susd.ovl_exp_grid_chk2_ty_susd = str2double(stats_rep(2).DeltaMonitoringGeneral.SuSd.Translation.Y) * 1e-9;

% K-factors (k7-k20 for 20par, or selection from k7-k51 for 35par)
kpi_corr.monitor.intra_delta = bmmo_parse_kpi_ho_rep_lis([], stats_rep(1).DeltaMonitoringGeneral.DeltaKFactors,...
    stats_rep(2).DeltaMonitoringGeneral.DeltaKFactors, true);



