function kpi_ovl = bmmo_parse_kpi_overlay(kpi_rep)
%
% function kpi_ovl = bmmo_parse_kpi_overlay(kpi_rep)
%
%Given  KPIs (99.7, M3s, Max, 3s) and statistics from the OTAS job report, parse the
%contents into a BMMO-NXE kpi structure
% Input:
%   kpi_rep:  KPIs from job report (99.7, M3s, Max, 3s)

%
% Output:
%   kpi_ovl :  KPI (99.7, M3s, Max, 3s) structure as generated by
%   BMMO model
% 
% Changelog
% 20171030 SBPR Creation

% mapping table from kpi rep 
if isfield(kpi_rep, 'StDev3')
    kpi_rep_map = {'Max', ...
        'Max99.7', ...
        'M3s', ...
        'StDev3', ...
        'X', ...
        'Y', ...
        'Chuck1', ...
        'Chuck2'};
    
    % mapping table from kpi out
    kpi_ovl_map = {'max', ...
        '997', ...
        'm3s', ...
        '3std', ...
        'x', ...
        'y', ...
        'chk1', ...
        'chk2'};
    
    stat_index = 1:4;
    dim_index = 5:6;
    chuck_index = 7:8;
else
    kpi_rep_map = {'Max', ...
        'Max99.7', ...
        'M3s', ...
        'X', ...
        'Y', ...
        'Chuck1', ...
        'Chuck2'};
    
    % mapping table from kpi out
    kpi_ovl_map = {'max', ...
        '997', ...
        'm3s', ...
        'x', ...
        'y', ...
        'chk1', ...
        'chk2'};
    
    stat_index = 1:3;
    dim_index = 4:5;
    chuck_index = 6:7;
end 

for istat = stat_index
    for idim = dim_index
        for ichuck = chuck_index
            fieldname = ['ovl_' kpi_ovl_map{ichuck} '_' kpi_ovl_map{istat} '_' kpi_ovl_map{idim}];
            datastr = kpi_rep.(kpi_rep_map{istat}).(kpi_rep_map{idim}).(kpi_rep_map{ichuck});
            kpi_ovl.(fieldname) = str2double(datastr) * 1e-9;
        end
    end
end
